name: Build sdk

on: [workflow_dispatch]

permissions: write-all

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@main
    
    - name: Initialize environment
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        sudo apt update 
        sudo apt install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
        gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
        file wget
      
    - name: Update feeds
      run: cd $GITHUB_WORKSPACE && ./scripts/feeds update -a
      
    - name: Install feeds
      run: cd $GITHUB_WORKSPACE && ./scripts/feeds install -a

    - name: Make defconfig
      run: |
        cd $GITHUB_WORKSPACE 
        mv .config-6.1-sdk .config
        make defconfig

    - name: Compile tools and toolchain
      run: |
        cd $GITHUB_WORKSPACE
        make -j$(nproc) tools/compile
        make -j$(nproc) toolchain/compile

    - name: Compile linux
      run: |
        cd $GITHUB_WORKSPACE
        make -j$(nproc) target/linux/compile

    - name: Compile sdk
      run: |
        cd $GITHUB_WORKSPACE
        make -j$(nproc) download
        make -j$(nproc)     

    - name: Upload directories
      uses: actions/upload-artifact@main
      with:
        name: build_upload
        path: |
          bin/targets/mvebu/cortexa9/openwrt-sdk-mvebu-cortexa9_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz

    - name: Upload files
      uses: maggie44/actions/packages/automatic-releases@built-packages
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: sdk-latest
        prerelease: false
        title: Latest sdk
        files: |
          bin/targets/mvebu/cortexa9/openwrt-sdk-mvebu-cortexa9_gcc-12.3.0_musl_eabi.Linux-x86_64.tar.xz
